%%manim -qm -v WARNING LezioneSuonoRedPressure

from manim import *
import numpy as np
import random

class LezioneSuonoRedPressure(Scene):
    def construct(self):
        # --- DEFINIZIONE COLORI ---
        COLOR_TITOLO = "#2660A4"
        COLOR_COMPRESSIONE = "#ABDF75"
        COLOR_RAREFAZIONE = "#60695C"
        COLOR_FREQUENZA = "#33CCFF" # Azzurro
        COLOR_LAMBDA = PURPLE       # Viola
        COLOR_VELOCITA = PINK       # Rosa
        # COLOR_P = YELLOW  <-- Non più usato per P

        # --- PANNELLO 1: TITOLO ---
        title_text = Tex(r"\textbf{Il suono}", font_size=96, color=COLOR_TITOLO)
        self.play(Write(title_text))
        self.wait(2)
        self.play(FadeOut(title_text))

        # --- PANNELLO 2: MEZZO MATERIALE ---
        box = Rectangle(width=9, height=3.5, color=WHITE)
        
        num_particles = 300
        particles = VGroup()
        for _ in range(num_particles):
            x = random.uniform(-4.3, 4.3)
            y = random.uniform(-1.6, 1.6)
            particles.add(Dot(point=[x, y, 0], radius=0.03, color=WHITE))
        
        text_mezzo = Tex(r"Mezzo materiale: aria", font_size=40, color=WHITE).next_to(box, DOWN, buff=0.7)

        self.play(Create(box), Create(particles))
        self.play(Write(text_mezzo))
        self.wait(1)

        # Animazione compressione
        new_positions = []
        for p in particles:
            x, y, z = p.get_center()
            if abs(x) < 1.5:
                new_x = x * 0.3
            elif abs(x) < 3:
                new_x = x * 0.7
            else:
                new_x = x
            new_positions.append([new_x, y, z])
            
        self.play(
            *[p.animate.move_to(pos) for p, pos in zip(particles, new_positions)],
            run_time=3,
            rate_func=smooth
        )
        self.wait(2)

        # --- PANNELLO 3: COMPRESSIONE E RAREFAZIONE ---
        label_comp = Tex("compressione", font_size=32, color=COLOR_COMPRESSIONE).move_to(box.get_top() + LEFT*1.5 + UP*0.3)
        label_rare = Tex("rarefazione", font_size=32, color=COLOR_RAREFAZIONE).move_to(box.get_top() + RIGHT*2.5 + UP*0.3)
        
        line_comp = Line(label_comp.get_bottom(), label_comp.get_bottom() + DOWN*0.2, color=COLOR_COMPRESSIONE)
        line_rare = Line(label_rare.get_bottom(), label_rare.get_bottom() + DOWN*0.2, color=COLOR_RAREFAZIONE)

        text_pressione = Tex(r"Non è aria che va avanti: è pressione che varia", font_size=40, color=WHITE).next_to(box, DOWN, buff=0.7)
        
        self.play(
            Write(label_comp), Write(line_comp),
            Write(label_rare), Write(line_rare),
            Transform(text_mezzo, text_pressione)
        )
        self.wait(3)
        
        # --- PANNELLO 4: PRESSIONE P ---
        # MODIFICA: Colore cambiato da COLOR_P a RED
        arrow_p = DoubleArrow(start=LEFT*0.8, end=RIGHT*0.8, buff=0, color=RED, tip_length=0.15).move_to(box.get_center()).shift(DOWN*0.7)
        # MODIFICA: Colore cambiato da COLOR_P a RED
        label_p = MathTex("P", font_size=40, color=RED).next_to(arrow_p, UP, buff=0.1)

        # MODIFICA: Imposta z-index per sovraimpressione (appare sopra le particelle)
        arrow_p.set_z_index(1)
        label_p.set_z_index(1)

        text_pressione_emph = Tex(r"Non è aria che va avanti: è \textit{pressione} che varia", font_size=40, color=WHITE).next_to(box, DOWN, buff=0.7)

        self.play(
            Create(arrow_p),
            Write(label_p),
            Transform(text_mezzo, text_pressione_emph)
        )
        self.wait(3)

        self.play(
            FadeOut(box), FadeOut(particles),
            FadeOut(label_comp), FadeOut(line_comp),
            FadeOut(label_rare), FadeOut(line_rare),
            FadeOut(arrow_p), FadeOut(label_p),
            FadeOut(text_mezzo)
        )

        # --- PANNELLO 5: FORMULE ---
        
        # DEFINIZIONI
        def_f = VGroup(
            Tex(r"Frequenza ", color=COLOR_FREQUENZA),
            MathTex("f", color=COLOR_FREQUENZA), 
            Tex(r": oscillazioni al secondo (Hz). Acuto se ", color=WHITE),
            MathTex("f", color=COLOR_FREQUENZA),
            Tex(r" è grande.", color=WHITE)
        ).arrange(RIGHT, buff=0.1).center()

        def_l = VGroup(
            Tex(r"Lunghezza d'onda ", color=COLOR_LAMBDA), 
            MathTex(r"\lambda", color=COLOR_LAMBDA), 
            Tex(r": distanza tra due compressioni.", color=WHITE)
        ).arrange(RIGHT, buff=0.1).center()
        
        def_v = VGroup(
            Tex(r"Velocità ", color=COLOR_VELOCITA),
            MathTex("v", color=COLOR_VELOCITA),
            Tex(r": velocità di propagazione.", color=WHITE)
        ).arrange(RIGHT, buff=0.1).center()

        definitions = VGroup(def_f, def_l, def_v).arrange(DOWN, buff=0.5).move_to(ORIGIN)
        
        # FORMULA
        formula = MathTex("v", "=", r"\lambda", "f", font_size=96)
        formula[0].set_color(COLOR_VELOCITA)
        formula[2].set_color(COLOR_LAMBDA)
        formula[3].set_color(COLOR_FREQUENZA)
        
        # NOTA INFERIORE
        line1 = VGroup(
            Tex("Nel solito mezzo ", font_size=28, color=WHITE),
            MathTex("v", font_size=28, color=COLOR_VELOCITA),
            Tex(" è quasi costante,", font_size=28, color=WHITE)
        ).arrange(RIGHT, buff=0.08)

        line2 = VGroup(
            Tex("quindi se ", font_size=28, color=WHITE),
            MathTex("f", font_size=28, color=COLOR_FREQUENZA),
            Tex(" aumenta allora ", font_size=28, color=WHITE),
            MathTex(r"\lambda", font_size=28, color=COLOR_LAMBDA),
            Tex(" diminuisce.", font_size=28, color=WHITE)
        ).arrange(RIGHT, buff=0.08)

        note = VGroup(line1, line2).arrange(DOWN, buff=0.2)

        self.play(Write(definitions))
        self.wait(2)
        self.play(definitions.animate.scale(0.7).to_edge(UP))
        
        self.play(Write(formula))
        self.wait(1)
        self.play(formula.animate.move_to(UP*0.5), Write(note.next_to(formula, DOWN, buff=1)))
        self.wait(3)
        self.play(FadeOut(definitions), FadeOut(formula), FadeOut(note))

        # --- PANNELLO 6: ONDA TRASVERSALE ---
        axes = Axes(
            x_range=[0, 12, 1], y_range=[-2, 2, 1],
            x_length=10, y_length=4,
            axis_config={"include_tip": False, "include_numbers": False, "color": WHITE}
        )
        
        sin_graph = axes.plot(lambda x: np.sin(x), color=WHITE)
        p1 = axes.c2p(PI/2, 1) 
        p2 = axes.c2p(2.5*PI, 1)
        brace = BraceBetweenPoints(p1, p2, UP, color=WHITE)
        
        lambda_label = MathTex(r"\lambda", color=COLOR_LAMBDA).next_to(brace, UP)
        
        bottom_text = VGroup(
            Tex("A ", color=WHITE),
            MathTex("v", color=COLOR_VELOCITA),
            Tex(" costante: ", color=WHITE),
            MathTex("f", color=COLOR_FREQUENZA),
            MathTex(r"\uparrow \Rightarrow", color=WHITE),
            MathTex(r"\lambda", color=COLOR_LAMBDA),
            MathTex(r"\downarrow", color=WHITE)
        ).arrange(RIGHT, buff=0.1).to_edge(DOWN)

        self.play(Create(axes), Create(sin_graph))
        self.play(GrowFromCenter(brace), Write(lambda_label))
        self.play(Write(bottom_text))
        self.wait(2)
        self.play(FadeOut(axes), FadeOut(sin_graph), FadeOut(brace), FadeOut(lambda_label), FadeOut(bottom_text))

        # --- PANNELLO 7: INTRODUZIONE DECIBEL ---
        db_formula = MathTex(r"\beta = 10 \log_{10}\left(\frac{I}{I_0}\right)", font_size=60, color=WHITE)
        db_formula.to_edge(UP, buff=1.5)
        
        db_text = Tex(r"Scala logaritmica: $\times 2 \Rightarrow +3$ dB", font_size=32, color=WHITE).next_to(db_formula, DOWN)
        
        calc_formula = MathTex(
            r"\lambda",     # 0
            "=",            # 1
            "{v",           # 2
            r"\over",       # 3
            "f}",           # 4
            "=",            # 5
            r"{343",        # 6
            r"\over",       # 7
            r"1000}",       # 8
            r"\, m",        # 9
            font_size=48, color=WHITE
        )
        
        calc_formula[0].set_color(COLOR_LAMBDA)   # lambda
        calc_formula[2].set_color(COLOR_VELOCITA) # v
        calc_formula[4].set_color(COLOR_FREQUENZA)# f
        
        calc_formula.next_to(db_text, DOWN, buff=1)
        
        result_text = Tex(r"Quindi: lunghezza d'onda = 34,3 cm", font_size=36, color=WHITE)
        result_text.next_to(calc_formula, DOWN)

        self.play(Write(db_formula))
        self.play(FadeIn(db_text))
        self.wait(1)
        self.play(Write(calc_formula))
        self.play(Write(result_text))
        self.wait(3)
        self.play(FadeOut(db_formula), FadeOut(db_text), FadeOut(calc_formula), FadeOut(result_text))

        # --- PANNELLO 8: SOMMARIO ---
        line = Line(LEFT*4, RIGHT*4, color=WHITE)
        
        summ_formula = MathTex("v", "=", r"\lambda", "f", ";", font_size=40, color=WHITE)
        summ_formula[0].set_color(COLOR_VELOCITA)
        summ_formula[2].set_color(COLOR_LAMBDA)
        summ_formula[3].set_color(COLOR_FREQUENZA)

        summary = VGroup(
            Text("Suono: onda meccanica, serve un mezzo;", font_size=32, color=WHITE),
            Text("in aria è pressione che varia;", font_size=32, color=WHITE),
            summ_formula,
            Tex(r"intensità: $1/r^2$; decibel logaritmici.", font_size=32, color=WHITE)
        ).arrange(DOWN, buff=0.4)
        
        self.play(Create(line))
        self.play(Write(summary))
        self.wait(3)
        self.play(FadeOut(summary), FadeOut(line))
        
        self.wait(2)